<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Asterisk Sites</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/content-tools@2.6.0/build/content-tools.min.css">
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      margin: 0;
      padding: 0;
      color: #333;
    }
    .page {
      display: none;
      padding: 20px;
    }
    .topbar {
      background: #f5f5f5;
      padding: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid #ddd;
    }
    #current-repo {
      font-family: monospace;
      padding: 5px 10px;
      background: #eee;
      border-radius: 3px;
    }
    .button-primary {
      background: #4CAF50;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
      margin-right: 5px;
    }
    .nav-button {
      background: #f0f0f0;
      border: 1px solid #ddd;
      padding: 6px 12px;
      border-radius: 4px;
      cursor: pointer;
      margin-right: 5px;
    }
    .token-note {
      font-size: 0.8em;
      color: #666;
    }
    #site-list {
      list-style: none;
      padding: 0;
      margin-top: 20px;
    }
    #site-list li {
      padding: 15px;
      border-bottom: 1px solid #eee;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    #site-list li:hover {
      background: #f9f9f9;
    }
    #editor-content {
      padding: 20px;
      max-width: 1000px;
      margin: 0 auto;
      min-height: 400px;
      border: 1px dashed #eee;
    }
    #status-message {
      position: fixed;
      bottom: 20px;
      right: 20px;
      padding: 10px 15px;
      background: #333;
      color: white;
      border-radius: 4px;
      display: none;
      z-index: 1000;
    }
    #debug-log {
      font-family: monospace;
      font-size: 12px;
      padding: 10px;
      background: #f0f0f0;
      max-height: 200px;
      overflow-y: auto;
      margin-top: 20px;
      display: none;
    }
  </style>
</head>
<body>
  <div class="topbar">
    <div>
      <button class="nav-button" onclick="showPage('home')">Home</button>
      <button class="nav-button" onclick="showPage('editor')">Editor</button>
      <button class="nav-button" onclick="showPage('settings')">Settings</button>
      <button onclick="saveToGitHub()" id="publish-button" class="button-primary" style="display: none;">Publish</button>
    </div>
    <div id="current-repo">No repo</div>
  </div>

  <div id="home" class="page">
    <h2>Your Sites</h2>
    <div>
      <button class="button-primary" onclick="createRepoAndEdit()">+ Create New Site</button>
      <button class="nav-button" onclick="loadRepos()">Refresh List</button>
    </div>
    <div id="site-list-container">
      <p id="loading-repos" style="display: none;">Loading repositories...</p>
      <ul id="site-list"></ul>
    </div>
  </div>

  <div id="settings" class="page">
    <h2>Settings</h2>
    <label>GitHub Access Token:</label><br>
    <input type="password" id="token" placeholder="Enter your GitHub token" style="width: 300px;"/><br>
    <p class="token-note">Note: Your token needs the 'repo' scope permissions to work properly.</p>
    <button onclick="saveToken()" class="button-primary">Save Token</button>
    <div style="margin-top: 20px;">
      <label><input type="checkbox" id="debug-mode" onchange="toggleDebug()"> Enable Debug Mode</label>
      <div id="debug-log"></div>
    </div>
  </div>

  <div id="editor" class="page">
    <div id="editor-container">
      <div id="editor-content" data-editable data-name="main-content">
        <!-- Editable content will be loaded here -->
        <h1>Welcome to the editor</h1>
        <p>Your content will appear here</p>
      </div>
    </div>
  </div>

  <div id="status-message"></div>

  <script src="https://cdn.jsdelivr.net/npm/content-tools@2.6.0/build/content-tools.min.js"></script>
  <script>
    // In-memory state since localStorage is not available
    let savedHTML = '';
    let githubToken = '';
    let repoName = '';
    let username = '';
    let editor = null;
    let debugMode = false;

    // Show the specified page and handle special cases
    function showPage(id) {
      // Hide all pages
      document.getElementById('home').style.display = 'none';
      document.getElementById('settings').style.display = 'none';
      document.getElementById('editor').style.display = 'none';
      
      // Show the requested page
      document.getElementById(id).style.display = 'block';
      
      // Show/hide publish button based on context
      document.getElementById('publish-button').style.display = 
        (id === 'editor' && repoName) ? 'inline-block' : 'none';
      
      // Special handling for different pages
      if (id === 'editor') {
        if (!editor || !editor.isActive()) {
          initEditor();
        }
      }
      
      if (id === 'home' && githubToken) {
        loadRepos();
      }
      
      debugLog(`Showing page: ${id}`);
    }

    // Display a status message to the user
    function showStatus(message, isError = false) {
      const statusElement = document.getElementById('status-message');
      statusElement.textContent = message;
      statusElement.style.backgroundColor = isError ? '#d32f2f' : '#43a047';
      statusElement.style.display = 'block';
      
      debugLog(isError ? 'ERROR: ' + message : 'INFO: ' + message);
      
      setTimeout(() => {
        statusElement.style.display = 'none';
      }, 3000);
    }

    // Add a message to the debug log
    function debugLog(message) {
      const logElement = document.getElementById('debug-log');
      const timestamp = new Date().toLocaleTimeString();
      const logMessage = `[${timestamp}] ${message}`;
      
      logElement.innerHTML += logMessage + '<br>';
      logElement.scrollTop = logElement.scrollHeight;
      
      console.log(logMessage);
    }

    // Toggle debug mode on/off
    function toggleDebug() {
      debugMode = document.getElementById('debug-mode').checked;
      document.getElementById('debug-log').style.display = debugMode ? 'block' : 'none';
      debugLog(`Debug mode ${debugMode ? 'enabled' : 'disabled'}`);
    }

    // Save the GitHub token and validate it
    function saveToken() {
      githubToken = document.getElementById('token').value.trim();
      if (!githubToken) {
        showStatus('Please enter a GitHub token', true);
        return;
      }
      
      showStatus('Token saved!');
      validateToken();
    }

    // Validate the GitHub token by making a test API call
    async function validateToken() {
      debugLog('Validating GitHub token...');
      
      try {
        const response = await fetch('https://api.github.com/user', {
          headers: {
            'Authorization': `token ${githubToken}`,
            'Accept': 'application/vnd.github.v3+json'
          }
        });
        
        if (!response.ok) {
          throw new Error(`GitHub API returned ${response.status}: ${response.statusText}`);
        }
        
        const userData = await response.json();
        username = userData.login;
        debugLog(`Token validated successfully. Logged in as: ${username}`);
        showStatus(`Authenticated as ${username}`);
        
        // Proceed to load repositories
        loadRepos();
      } catch (error) {
        debugLog(`Token validation failed: ${error.message}`);
        showStatus('Invalid token! Please check your GitHub access token.', true);
      }
    }

    // Load all repositories from GitHub
    async function loadRepos() {
      if (!githubToken) {
        showStatus('Please enter a GitHub token in Settings first', true);
        showPage('settings');
        return;
      }
      
      document.getElementById('loading-repos').style.display = 'block';
      document.getElementById('site-list').innerHTML = '';
      
      debugLog('Fetching repositories...');
      
      try {
        const response = await fetch('https://api.github.com/user/repos?per_page=100', {
          headers: {
            'Authorization': `token ${githubToken}`,
            'Accept': 'application/vnd.github.v3+json'
          }
        });
        
        if (!response.ok) {
          throw new Error(`API returned ${response.status}: ${response.statusText}`);
        }
        
        const repos = await response.json();
        debugLog(`Found ${repos.length} repositories`);
        
        const list = document.getElementById('site-list');
        list.innerHTML = '';
        
        // Show all repos instead of filtering for Asterisk Sites
        if (repos.length === 0) {
          list.innerHTML = '<li>No repositories found. Create a new site to get started!</li>';
        } else {
          for (const repo of repos) {
            const li = document.createElement('li');
            
            const repoInfo = document.createElement('div');
            repoInfo.innerHTML = `<strong>${repo.name}</strong>`;
            if (repo.description) {
              repoInfo.innerHTML += `<br><span style="color: #666;">${repo.description}</span>`;
            }
            li.appendChild(repoInfo);
            
            const buttonsDiv = document.createElement('div');
            
            // Edit button
            const editButton = document.createElement('button');
            editButton.textContent = 'Edit';
            editButton.className = 'nav-button';
            editButton.onclick = (e) => {
              e.stopPropagation();
              openRepo(repo.name, repo.owner.login);
            };
            buttonsDiv.appendChild(editButton);
            
            // View button if GitHub Pages is enabled
            if (repo.has_pages) {
              const viewButton = document.createElement('button');
              viewButton.textContent = 'View Site';
              viewButton.className = 'nav-button';
              viewButton.style.marginLeft = '5px';
              viewButton.onclick = (e) => {
                e.stopPropagation();
                window.open(`https://${repo.owner.login}.github.io/${repo.name}`, '_blank');
              };
              buttonsDiv.appendChild(viewButton);
            }
            
            li.appendChild(buttonsDiv);
            list.appendChild(li);
          }
        }
      } catch (error) {
        debugLog(`Error loading repositories: ${error.message}`);
        showStatus('Failed to load repositories. Check your GitHub token.', true);
        list.innerHTML = '<li>Error loading repositories. Please check your token permissions.</li>';
      } finally {
        document.getElementById('loading-repos').style.display = 'none';
      }
    }

    // Open a repository for editing
    async function openRepo(name, user) {
      repoName = name;
      username = user;
      document.getElementById('current-repo').innerText = `${username}/${repoName}`;
      showStatus(`Opening ${repoName}...`);
      debugLog(`Opening repository: ${username}/${repoName}`);
      
      try {
        // First check if index.html exists
        const resp = await fetch(`https://api.github.com/repos/${username}/${repoName}/contents/index.html`, {
          headers: {
            'Authorization': `token ${githubToken}`,
            'Accept': 'application/vnd.github.v3+json'
          }
        });
        
        let bodyContent = '';
        
        if (resp.ok) {
          const data = await resp.json();
          const htmlContent = atob(data.content);
          
          // Extract just the body content for editing
          const bodyMatch = htmlContent.match(/<body[^>]*>([\s\S]*?)<\/body>/i);
          if (bodyMatch && bodyMatch[1]) {
            bodyContent = bodyMatch[1];
          }
        }
        
        // If no index.html or couldn't extract body content, use default content
        if (!bodyContent) {
          bodyContent = '<h1>Welcome to Asterisk Sites</h1><p>Edit this content to get started.</p>';
          debugLog('No index.html found or could not extract body content, using default content');
        }
        
        document.getElementById('editor-content').innerHTML = bodyContent;
        
        // Switch to editor page first
        showPage('editor');
        
        // Then initialize/reset the editor
        if (editor) {
          editor.destroy();
          editor = null;
        }
        initEditor();
        
        showStatus(`Opened ${repoName} successfully`);
      } catch (error) {
        debugLog(`Error opening repository: ${error.message}`);
        showStatus(`Error loading content from ${repoName}`, true);
        
        // Still switch to editor with default content
        document.getElementById('editor-content').innerHTML = '<h1>New Content</h1><p>Start editing here.</p>';
        showPage('editor');
        initEditor();
      }
    }

    // Create a new repository and prepare it for editing
    async function createRepoAndEdit() {
      if (!githubToken) {
        showStatus('Please set your GitHub token in Settings first', true);
        showPage('settings');
        return;
      }

      repoName = prompt('Enter repository name:');
      if (!repoName) return;
      
      repoName = repoName.trim().replace(/\s+/g, '-').toLowerCase();
      
      showStatus(`Creating repository ${repoName}...`);
      debugLog(`Creating new repository: ${repoName}`);

      try {
        // Get user info if not already set
        if (!username) {
          const userResp = await fetch('https://api.github.com/user', {
            headers: {
              'Authorization': `token ${githubToken}`,
              'Accept': 'application/vnd.github.v3+json'
            }
          });
          
          if (!userResp.ok) {
            throw new Error(`Failed to get user info: ${userResp.status} ${userResp.statusText}`);
          }
          
          const userInfo = await userResp.json();
          username = userInfo.login;
          debugLog(`Got username: ${username}`);
        }

        // Create the repository
        const createRepoResp = await fetch('https://api.github.com/user/repos', {
          method: 'POST',
          headers: {
            'Authorization': `token ${githubToken}`,
            'Accept': 'application/vnd.github.v3+json',
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ 
            name: repoName, 
            auto_init: true,
            description: 'Created with Asterisk Sites'
          })
        });

        if (!createRepoResp.ok) {
          const errorData = await createRepoResp.json();
          throw new Error(`Repository creation failed: ${errorData.message}`);
        }
        
        debugLog(`Repository created: ${username}/${repoName}`);
        document.getElementById('current-repo').innerText = `${username}/${repoName}`;
        
        // Initialize the editor with default content
        const defaultContent = `
          <h1>Welcome to ${repoName}!</h1>
          <p>This is your new site created with Asterisk Sites. Edit this page to customize your site.</p>
          <h2>Getting Started</h2>
          <p>Click on any text to edit it. Use the tools that appear to format your content.</p>
          <p>When you're done making changes, click the Publish button to update your site.</p>
        `;
        
        document.getElementById('editor-content').innerHTML = defaultContent;
        
        // Switch to editor page first
        showPage('editor');
        
        // Then initialize the editor
        if (editor) {
          editor.destroy();
          editor = null;
        }
        initEditor();
        
        // Save the initial content
        await saveToGitHub();
        
        // Enable GitHub Pages
        await enableGitHubPages();
        
        // Refresh the repo list
        await loadRepos();
      } catch (error) {
        debugLog(`Error creating repository: ${error.message}`);
        showStatus(`Error: ${error.message}`, true);
      }
    }

    // Enable GitHub Pages for the current repository
    async function enableGitHubPages() {
      try {
        debugLog(`Enabling GitHub Pages for ${username}/${repoName}...`);
        
        const response = await fetch(`https://api.github.com/repos/${username}/${repoName}/pages`, {
          method: 'POST',
          headers: {
            'Authorization': `token ${githubToken}`,
            'Accept': 'application/vnd.github.v3+json',
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            source: {
              branch: 'main',
              directory: '/'
            }
          })
        });
        
        if (response.status === 201 || response.status === 204) {
          debugLog('GitHub Pages enabled successfully');
          showStatus('GitHub Pages enabled! Site will be available soon.');
          return true;
        } else {
          const errorData = await response.json();
          throw new Error(`GitHub Pages setup failed: ${errorData.message}`);
        }
      } catch (error) {
        debugLog(`Error enabling GitHub Pages: ${error.message}`);
        showStatus('Failed to enable GitHub Pages. You can try again later.', true);
        return false;
      }
    }

    // Initialize the ContentTools editor
    function initEditor() {
      debugLog('Initializing content editor');
      
      try {
        // Initialize ContentTools
        ContentTools.StylePalette.add([
          new ContentTools.Style('Title', 'title', ['h1']),
          new ContentTools.Style('Subtitle', 'subtitle', ['h2']),
          new ContentTools.Style('Paragraph', 'paragraph', ['p']),
          new ContentTools.Style('Button', 'button', ['a'])
        ]);
        
        editor = ContentTools.EditorApp.get();
        editor.init('[data-editable]', 'data-name');
        
        // Add save handler
        editor.addEventListener('saved', function (ev) {
          const regions = ev.detail().regions;
          if (regions && regions['main-content']) {
            savedHTML = regions['main-content'];
            document.getElementById('editor-content').innerHTML = savedHTML;
            debugLog('Content saved in editor');
          }
        });
        
        debugLog('Editor initialized successfully');
      } catch (error) {
        debugLog(`Error initializing editor: ${error.message}`);
        showStatus('Error initializing editor. Please refresh the page.', true);
      }
    }

    // Save the current content to GitHub
    async function saveToGitHub() {
      if (!repoName || !username) {
        showStatus('No repository selected', true);
        return false;
      }
      
      try {
        // Save any pending changes in the editor
        if (editor && editor.isActive()) {
          editor.save(true);
          await new Promise(resolve => setTimeout(resolve, 500)); // Give time for the save event to process
        }
        
        showStatus('Publishing to GitHub...');
        debugLog(`Saving content to ${username}/${repoName}...`);
        
        // Get the current content
        const bodyContent = document.getElementById('editor-content').innerHTML;
        
        const fullContent = `<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>${repoName}</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      line-height: 1.6;
      color: #333;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
    }
    h1 {
      color: #2c3e50;
    }
    h2 {
      color: #3498db;
    }
    a {
      color: #2980b9;
      text-decoration: none;
    }
    a:hover {
      text-decoration: underline;
    }
    .button {
      display: inline-block;
      background: #3498db;
      color: white;
      padding: 8px 16px;
      border-radius: 4px;
      margin: 5px 0;
    }
    .button:hover {
      background: #2980b9;
      text-decoration: none;
    }
    /* Asterisk Sites marker - do not remove */
  </style>
</head>
<body>${bodyContent}</body>
</html>`;

        const path = 'index.html';
        const apiUrl = `https://api.github.com/repos/${username}/${repoName}/contents/${path}`;

        // Check if file already exists
        let sha = undefined;
        try {
          const getResp = await fetch(apiUrl, {
            headers: {
              'Authorization': `token ${githubToken}`,
              'Accept': 'application/vnd.github.v3+json'
            }
          });
          
          if (getResp.ok) {
            const fileData = await getResp.json();
            sha = fileData.sha;
            debugLog(`Existing file found with SHA: ${sha}`);
          }
        } catch (error) {
          debugLog('File does not exist yet, creating new one');
        }

        // Update or create the file
        const putResp = await fetch(apiUrl, {
          method: 'PUT',
          headers: {
            'Authorization': `token ${githubToken}`,
            'Accept': 'application/vnd.github.v3+json',
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            message: 'Update site content via Asterisk Sites',
            content: btoa(unescape(encodeURIComponent(fullContent))),
            sha,
            committer: {
              name: username,
              email: `${username}@users.noreply.github.com`
            }
          })
        });

        if (putResp.ok) {
          debugLog('Content published successfully to GitHub');
          showStatus('Published successfully!');
          return true;
        } else {
          const errorData = await putResp.json();
          throw new Error(`Failed to save content: ${errorData.message}`);
        }
      } catch (error) {
        debugLog(`Error saving to GitHub: ${error.message}`);
        showStatus(`Failed to publish: ${error.message}`, true);
        return false;
      }
    }

    // Initialize the application
    debugLog('Application initialized');
    document.getElementById('debug-mode').checked = true;
    toggleDebug();
    showPage('settings');
  </script>
</body>
</html>