<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Asterisk Sites</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/content-tools@2.6.0/build/content-tools.min.css">
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      margin: 0;
      padding: 0;
      color: #333;
    }
    .page {
      display: none;
      padding: 20px;
    }
    .topbar {
      background: #f5f5f5;
      padding: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid #ddd;
    }
    #current-repo {
      font-family: monospace;
      padding: 5px 10px;
      background: #eee;
      border-radius: 3px;
    }
    .button-primary {
      background: #4CAF50;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
    }
    .nav-button {
      background: #f0f0f0;
      border: 1px solid #ddd;
      padding: 6px 12px;
      border-radius: 4px;
      cursor: pointer;
      margin-right: 5px;
    }
    .token-note {
      font-size: 0.8em;
      color: #666;
    }
    #site-list {
      list-style: none;
      padding: 0;
    }
    #site-list li {
      padding: 10px;
      border-bottom: 1px solid #eee;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    #site-list li:hover {
      background: #f9f9f9;
    }
    #editor-content {
      padding: 20px;
      max-width: 1000px;
      margin: 0 auto;
      min-height: 400px;
      border: 1px dashed #eee;
    }
    #status-message {
      position: fixed;
      bottom: 20px;
      right: 20px;
      padding: 10px 15px;
      background: #333;
      color: white;
      border-radius: 4px;
      display: none;
      z-index: 1000;
    }
    #debug-log {
      font-family: monospace;
      font-size: 12px;
      padding: 10px;
      background: #f0f0f0;
      max-height: 200px;
      overflow-y: auto;
      margin-top: 20px;
      display: none;
    }
  </style>
</head>
<body>
  <div class="topbar">
    <div>
      <button class="nav-button" onclick="showPage('home')">Home</button>
      <button class="nav-button" onclick="showPage('editor')">Editor</button>
      <button class="nav-button" onclick="showPage('settings')">Settings</button>
      <button onclick="saveToGitHub()" id="publish-button" class="button-primary">Publish</button>
    </div>
    <div id="current-repo">No repo</div>
  </div>

  <div id="home" class="page">
    <h2>Your Sites</h2>
    <button class="button-primary" onclick="createRepoAndEdit()">+ Create New Site</button>
    <div id="site-list-container">
      <p id="loading-repos" style="display: none;">Loading repositories...</p>
      <ul id="site-list"></ul>
    </div>
  </div>

  <div id="settings" class="page">
    <h2>Settings</h2>
    <label>GitHub Access Token:</label><br>
    <input type="password" id="token" placeholder="Enter your GitHub token" style="width: 300px;"/><br>
    <p class="token-note">Note: Your token needs the 'repo' and 'delete_repo' scope permissions.</p>
    <button onclick="saveToken()" class="button-primary">Save Token</button>
    <div>
      <label><input type="checkbox" id="debug-mode" onchange="toggleDebug()"> Enable Debug Mode</label>
      <div id="debug-log"></div>
    </div>
  </div>

  <div id="editor" class="page">
    <div id="editor-content" data-editable data-name="main-content">
      <!-- Editable content will be loaded here -->
    </div>
  </div>

  <div id="status-message"></div>

  <script src="https://cdn.jsdelivr.net/npm/content-tools@2.6.0/build/content-tools.min.js"></script>
  <script>
    let savedHTML = '', githubToken = '', repoName = '', username = '';
    let editor = null;
    let debugMode = false;

    function showPage(id) {
      document.getElementById('home').style.display = 'none';
      document.getElementById('settings').style.display = 'none';
      document.getElementById('editor').style.display = 'none';
      document.getElementById(id).style.display = 'block';
      document.getElementById('publish-button').style.display = (id === 'editor' && repoName) ? 'inline-block' : 'none';
      
      if (id === 'editor' && !editor) {
        initEditor();
      }
      
      if (id === 'home' && githubToken) {
        loadRepos();
      }
    }

    function showStatus(message, isError = false) {
      const statusElement = document.getElementById('status-message');
      statusElement.textContent = message;
      statusElement.style.backgroundColor = isError ? '#d32f2f' : '#43a047';
      statusElement.style.display = 'block';
      
      if (isError) {
        debugLog('ERROR: ' + message);
      } else {
        debugLog('INFO: ' + message);
      }
      
      setTimeout(() => {
        statusElement.style.display = 'none';
      }, 3000);
    }

    function debugLog(message) {
      const logElement = document.getElementById('debug-log');
      const timestamp = new Date().toLocaleTimeString();
      logElement.innerHTML += `[${timestamp}] ${message}<br>`;
      logElement.scrollTop = logElement.scrollHeight;
      
      console.log(`[${timestamp}] ${message}`);
    }

    function toggleDebug() {
      debugMode = document.getElementById('debug-mode').checked;
      document.getElementById('debug-log').style.display = debugMode ? 'block' : 'none';
    }

    function saveToken() {
      githubToken = document.getElementById('token').value;
      if (!githubToken) {
        showStatus('Please enter a GitHub token', true);
        return;
      }
      
      localStorage.setItem('githubToken', githubToken);
      showStatus('Token saved!');
      validateToken();
    }

    async function validateToken() {
      debugLog('Validating GitHub token...');
      
      try {
        const response = await fetch('https://api.github.com/user', {
          headers: {
            'Authorization': `token ${githubToken}`
          }
        });
        
        if (!response.ok) {
          throw new Error(`GitHub API returned ${response.status}: ${response.statusText}`);
        }
        
        const userData = await response.json();
        username = userData.login;
        debugLog(`Token validated successfully. Logged in as: ${username}`);
        showStatus(`Authenticated as ${username}`);
        loadRepos();
      } catch (error) {
        debugLog(`Token validation failed: ${error.message}`);
        showStatus('Invalid token! Please check your GitHub access token.', true);
      }
    }

    function loadToken() {
      githubToken = localStorage.getItem('githubToken') || '';
      if (githubToken) {
        document.getElementById('token').value = githubToken;
        debugLog('Loaded token from localStorage');
        validateToken();
      }
    }

    async function loadRepos() {
      if (!githubToken) {
        debugLog('No GitHub token available. Cannot load repositories.');
        return;
      }
      
      document.getElementById('loading-repos').style.display = 'block';
      document.getElementById('site-list').innerHTML = '';
      
      debugLog('Fetching repositories...');
      
      try {
        const response = await fetch('https://api.github.com/user/repos?per_page=100', {
          headers: {
            'Authorization': `token ${githubToken}`,
            'Accept': 'application/vnd.github.v3+json'
          }
        });
        
        if (!response.ok) {
          throw new Error(`API returned ${response.status}: ${response.statusText}`);
        }
        
        const repos = await response.json();
        debugLog(`Found ${repos.length} repositories`);
        
        const list = document.getElementById('site-list');
        list.innerHTML = '';
        
        let asteriskSites = 0;
        
        for (const repo of repos) {
          try {
            // Check if this is an Asterisk Site by looking for index.html
            const indexResponse = await fetch(`https://api.github.com/repos/${repo.owner.login}/${repo.name}/contents/index.html`, {
              headers: {
                'Authorization': `token ${githubToken}`,
                'Accept': 'application/vnd.github.v3+json'
              }
            });
            
            if (!indexResponse.ok) {
              continue; // Skip this repo if it doesn't have an index.html
            }
            
            const indexData = await indexResponse.json();
            const htmlContent = atob(indexData.content);
            
            // Only include repos that have our marker
            if (!htmlContent.includes('Asterisk Sites')) {
              continue;
            }
            
            asteriskSites++;
            
            const li = document.createElement('li');
            
            const repoInfo = document.createElement('div');
            repoInfo.innerHTML = `<strong>${repo.name}</strong>`;
            li.appendChild(repoInfo);
            
            const buttonsDiv = document.createElement('div');
            
            // Edit button
            const editButton = document.createElement('button');
            editButton.textContent = 'Edit';
            editButton.className = 'nav-button';
            editButton.onclick = (e) => {
              e.stopPropagation();
              openRepo(repo.name, repo.owner.login);
            };
            buttonsDiv.appendChild(editButton);
            
            // View button if GitHub Pages is enabled
            if (repo.has_pages) {
              const viewButton = document.createElement('button');
              viewButton.textContent = 'View Site';
              viewButton.className = 'nav-button';
              viewButton.style.marginLeft = '5px';
              viewButton.onclick = (e) => {
                e.stopPropagation();
                window.open(`https://${repo.owner.login}.github.io/${repo.name}`, '_blank');
              };
              buttonsDiv.appendChild(viewButton);
            }
            
            li.appendChild(buttonsDiv);
            list.appendChild(li);
          } catch (error) {
            debugLog(`Error processing repo ${repo.name}: ${error.message}`);
          }
        }
        
        if (asteriskSites === 0) {
          list.innerHTML = '<li>No Asterisk Sites found. Create a new site to get started!</li>';
        }
        
        debugLog(`Displayed ${asteriskSites} Asterisk Sites`);
      } catch (error) {
        debugLog(`Error loading repositories: ${error.message}`);
        showStatus('Failed to load repositories. Check your GitHub token.', true);
      } finally {
        document.getElementById('loading-repos').style.display = 'none';
      }
    }

    async function openRepo(name, user) {
      repoName = name;
      username = user;
      document.getElementById('current-repo').innerText = `${username}/${repoName}`;
      showStatus(`Opening ${repoName}...`);
      debugLog(`Opening repository: ${username}/${repoName}`);
      
      try {
        const resp = await fetch(`https://api.github.com/repos/${username}/${repoName}/contents/index.html`, {
          headers: {
            'Authorization': `token ${githubToken}`,
            'Accept': 'application/vnd.github.v3+json'
          }
        });
        
        if (!resp.ok) {
          throw new Error(`Failed to get index.html: ${resp.status} ${resp.statusText}`);
        }
        
        const data = await resp.json();
        const htmlContent = atob(data.content);
        
        // Extract just the body content for editing
        let bodyContent = '';
        const bodyMatch = htmlContent.match(/<body>([\s\S]*?)<\/body>/i);
        if (bodyMatch && bodyMatch[1]) {
          bodyContent = bodyMatch[1];
        } else {
          bodyContent = '<h1>Welcome to Asterisk Sites</h1><p>Edit this content to get started.</p>';
          debugLog('Could not extract body content, using default content');
        }
        
        document.getElementById('editor-content').innerHTML = bodyContent;
        initEditor();
        showPage('editor');
        showStatus(`Opened ${repoName} successfully`);
      } catch (error) {
        debugLog(`Error opening repository: ${error.message}`);
        showStatus(`Error loading content from ${repoName}`, true);
      }
    }

    async function createRepoAndEdit() {
      if (!githubToken) {
        showStatus('Please set your GitHub token in Settings first', true);
        showPage('settings');
        return;
      }

      repoName = prompt('Enter repository name:');
      if (!repoName) return;
      
      repoName = repoName.trim().replace(/\s+/g, '-').toLowerCase();
      
      showStatus(`Creating repository ${repoName}...`);
      debugLog(`Creating new repository: ${repoName}`);

      try {
        // Get user info if not already set
        if (!username) {
          const userResp = await fetch('https://api.github.com/user', {
            headers: {
              'Authorization': `token ${githubToken}`,
              'Accept': 'application/vnd.github.v3+json'
            }
          });
          
          if (!userResp.ok) {
            throw new Error(`Failed to get user info: ${userResp.status} ${userResp.statusText}`);
          }
          
          const userInfo = await userResp.json();
          username = userInfo.login;
          debugLog(`Got username: ${username}`);
        }

        // Create the repository
        const createRepoResp = await fetch('https://api.github.com/user/repos', {
          method: 'POST',
          headers: {
            'Authorization': `token ${githubToken}`,
            'Accept': 'application/vnd.github.v3+json',
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ 
            name: repoName, 
            auto_init: true,
            description: 'Created with Asterisk Sites'
          })
        });

        if (!createRepoResp.ok) {
          const errorData = await createRepoResp.json();
          throw new Error(`Repository creation failed: ${errorData.message}`);
        }
        
        debugLog(`Repository created: ${username}/${repoName}`);
        document.getElementById('current-repo').innerText = `${username}/${repoName}`;
        
        // Initialize the editor with default content
        document.getElementById('editor-content').innerHTML = `
          <h1>Welcome to ${repoName}!</h1>
          <p>This is your new site created with Asterisk Sites. Edit this page to customize your site.</p>
          <h2>Getting Started</h2>
          <p>Click on any text to edit it. Use the tools that appear to format your content.</p>
          <p>When you're done making changes, click the Publish button to update your site.</p>
        `;
        
        initEditor();
        showPage('editor');
        
        // Save the initial content
        await saveToGitHub();
        
        // Enable GitHub Pages
        await enableGitHubPages();
        
        // Refresh the repo list
        await loadRepos();
      } catch (error) {
        debugLog(`Error creating repository: ${error.message}`);
        showStatus(`Error: ${error.message}`, true);
      }
    }

    async function enableGitHubPages() {
      try {
        debugLog(`Enabling GitHub Pages for ${username}/${repoName}...`);
        
        const response = await fetch(`https://api.github.com/repos/${username}/${repoName}/pages`, {
          method: 'POST',
          headers: {
            'Authorization': `token ${githubToken}`,
            'Accept': 'application/vnd.github.v3+json',
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            source: {
              branch: 'main',
              directory: '/'
            }
          })
        });
        
        if (response.status === 201 || response.status === 204) {
          debugLog('GitHub Pages enabled successfully');
          showStatus('GitHub Pages enabled! Site will be available soon.');
          return true;
        } else {
          const errorData = await response.json();
          throw new Error(`GitHub Pages setup failed: ${errorData.message}`);
        }
      } catch (error) {
        debugLog(`Error enabling GitHub Pages: ${error.message}`);
        showStatus('Failed to enable GitHub Pages. You can try again later.', true);
        return false;
      }
    }

    function initEditor() {
      if (editor) {
        editor.destroy();
      }
      
      debugLog('Initializing content editor');
      
      // Initialize ContentTools
      ContentTools.StylePalette.add([
        new ContentTools.Style('Title', 'title', ['h1']),
        new ContentTools.Style('Subtitle', 'subtitle', ['h2']),
        new ContentTools.Style('Paragraph', 'paragraph', ['p']),
        new ContentTools.Style('Button', 'button', ['a'])
      ]);
      
      editor = ContentTools.EditorApp.get();
      editor.init('[data-editable]', 'data-name');
      
      // Add save handler
      editor.addEventListener('saved', function (ev) {
        const regions = ev.detail().regions;
        if (regions && regions['main-content']) {
          savedHTML = regions['main-content'];
          document.getElementById('editor-content').innerHTML = savedHTML;
          debugLog('Content saved in editor');
        }
      });
    }

    async function saveToGitHub() {
      try {
        // Save any pending changes in the editor
        if (editor) {
          editor.save(true);
          await new Promise(resolve => setTimeout(resolve, 500)); // Give time for the save event to process
        }
        
        showStatus('Publishing to GitHub...');
        debugLog(`Saving content to ${username}/${repoName}...`);
        
        // Get the current content
        const bodyContent = document.getElementById('editor-content').innerHTML;
        
        const fullContent = `<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>${repoName}</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      line-height: 1.6;
      color: #333;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
    }
    h1 {
      color: #2c3e50;
    }
    h2 {
      color: #3498db;
    }
    a {
      color: #2980b9;
      text-decoration: none;
    }
    a:hover {
      text-decoration: underline;
    }
    .button {
      display: inline-block;
      background: #3498db;
      color: white;
      padding: 8px 16px;
      border-radius: 4px;
      margin: 5px 0;
    }
    .button:hover {
      background: #2980b9;
      text-decoration: none;
    }
    /* Asterisk Sites marker - do not remove */
  </style>
</head>
<body>${bodyContent}</body>
</html>`;

        const path = 'index.html';
        const apiUrl = `https://api.github.com/repos/${username}/${repoName}/contents/${path}`;

        // Check if file already exists
        let sha = undefined;
        try {
          const getResp = await fetch(apiUrl, {
            headers: {
              'Authorization': `token ${githubToken}`,
              'Accept': 'application/vnd.github.v3+json'
            }
          });
          
          if (getResp.ok) {
            const fileData = await getResp.json();
            sha = fileData.sha;
            debugLog(`Existing file found with SHA: ${sha}`);
          }
        } catch (error) {
          debugLog('File does not exist yet, creating new one');
        }

        // Update or create the file
        const putResp = await fetch(apiUrl, {
          method: 'PUT',
          headers: {
            'Authorization': `token ${githubToken}`,
            'Accept': 'application/vnd.github.v3+json',
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            message: 'Update site content via Asterisk Sites',
            content: btoa(unescape(encodeURIComponent(fullContent))),
            sha,
            committer: {
              name: username,
              email: `${username}@users.noreply.github.com`
            }
          })
        });

        if (putResp.ok) {
          debugLog('Content published successfully to GitHub');
          showStatus('Published successfully!');
          return true;
        } else {
          const errorData = await putResp.json();
          throw new Error(`Failed to save content: ${errorData.message}`);
        }
      } catch (error) {
        debugLog(`Error saving to GitHub: ${error.message}`);
        showStatus(`Failed to publish: ${error.message}`, true);
        return false;
      }
    }

    // Initialize the application
    loadToken();
    showPage('home');
  </script>
</body>
</html>